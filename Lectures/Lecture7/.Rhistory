## Get service interruption (SI) data - i.e. shutoff records (microdata)
## -----------------------------------------------------------------------------
#get service interruption data
input_si <- read.dta13("Data/si_1017_cleaned.dta")
#what is the unit of observation? each observation is a shutoff record.
#focus on key variables to identify period/location of every shutoff
#we'll want to join to demographic data based on tractid and get tract-level obs
si.clean <- input_si %>%
select(si_order_number, census_tract_long, year, month) %>%
rename(tractid = census_tract_long) %>%
arrange(tractid, year, month)
#aggregate to tract-year/month totals
si_tract_ym <- si.clean %>%
group_by(tractid, year, month) %>%
summarise(si_count = n_distinct(si_order_number)) %>%
arrange(tractid, year, month)
#inspect
summary(si_tract_ym)
table(si_tract_ym$month, si_tract_ym$year) #what does this tell us?
## -----------------------------------------------------------------------------
## Join shutoff & demographic data: construct tract-year/month panel
## -----------------------------------------------------------------------------
#join tract-yr demographic data (MI_acs_tract_10_17) to
# tract-month shutoff data (si_tract_ym)
#only keep tracts that are in the shutoff data (si_tract_ym)
#MI_acs_tract_10_17 includes Detroit tracts (Wayne County),
#but also tracts outside of Detroit across the state of Michigan
#want to end up with a tract-year-month panel
#new df should include: all columns from two dfs and a new date column
#also filter out observation for 2017-11-01 due to incomplete data
#HINT: what column(s) do you want to join on?
#HINT: what kind of join would work here?
tract_ym <- left_join(si_tract_ym, MI_acs_tract_10_17,
by = c("tractid", "year")) %>%
mutate(date = make_date(year, month, 1)) %>%
arrange(tractid, year, month) %>%
filter(date != "2017-11-01")
#inspect
summary(tract_ym)
#do we have a balanced panel?
table(tract_ym$month, tract_ym$year)
tract_ym %>%
group_by(tractid) %>%
count(tractid) %>%
arrange(n)
#nope, if a tract had 0 shutoffs one month -> no row for that tract-month
#collapse to tract-level totals (summed over all year-months)
#i.e. a single obs per tract with shutoffs summed over all years
#include time-invariant measures of other variables
#NOTE: this allows us to focus on variation between tracts
# (not within-tracts over time)
# will no longer be a panel dataframe
tract <- tract_ym %>%
group_by(tractid) %>% #kills time dimension
summarise(si_count = sum(si_count),
pop = mean(pop, na.rm = TRUE),
blackshare = mean(blackshare, na.rm = TRUE),
black75 = round(mean(black75, na.rm = TRUE), 0),
medianinc = mean(medianinc, na.rm = TRUE),
inc_above_median = round(mean(inc_above_median,
na.rm = TRUE), 0) ) %>%
mutate(si_1000 = si_count / (pop / 1000) ) %>% #shutoffs per 1000 people
arrange(tractid)
#inspect
summary(tract)
#what is the unit of observation? 1 observation for each census tract.
## -----------------------------------------------------------------------------
## 1. Cross-sectional analysis: tract-level income, race & shutoffs
## -----------------------------------------------------------------------------
#NOTE: here "cross-sectional" means 1 obs per tract
# (w/shutoffs summed over all years)
#scatterplot: % black vs shutoffs
ggplot(data = tract,
aes(x = blackshare, y = si_1000)) +
geom_point()
#compute correlation to assess model fit (in addition to visual inspection)
cor(tract$blackshare, tract$si_1000, use = "pairwise.complete.obs")
wtd.cor(tract$blackshare, tract$si_1000, weight = tract$pop)
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(readstata13)
library(tidyverse)
library(lubridate)
library(weights)
getwd()
ggplot(data = tract,
aes(x = blackshare,
y = si_1000,
size = pop)) +
geom_point(alpha = 0.1, color = "red") +
scale_size(range = c(0.1, 6), guide = "none") +
labs(title = "Black Share and Shutoffs per Capita", x = "% Black",
y = "Shutoffs per Capita") +
theme_light()
wtd.cor(tract$blackshare, tract$si_1000, weight = tract$pop)
unlink("Code/Assignment5-plc2137_cache", recursive = TRUE)
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(readstata13)
library(tidyverse)
library(lubridate)
library(weights)
getwd()
ggplot(data = tract,
aes(x = blackshare,
y = si_1000,
size = pop)) +
geom_point(alpha = 0.1, color = "red") +
scale_size(range = c(0.1, 6), guide = "none") +
labs(title = "Black Share and Shutoffs per Capita", x = "% Black",
y = "Shutoffs per Capita") +
theme_light()
wtd.cor(tract$blackshare, tract$si_1000, weight = tract$pop)
ggplot(data = tract,
aes(x = medianinc,
y = si_1000,
size = pop)) +
geom_point(alpha = 0.1, color = "green") +
scale_size(range = c(0.1, 6), guide = "none") +
labs(title = "Median Income vs. Shutoffs per Capita", x = "Median Income",
y = "Shutoffs per Captia") +
theme_light()
ggplot(data = tract,
aes(x = medianinc,
y = si_1000,
size = pop)) +
geom_point(alpha = 0.1, color = "blue") +
scale_size(range = c(0.1, 6), guide = "none") +
labs(title = "Median Income vs. Shutoffs per Capita", x = "Median Income",
y = "Shutoffs per Captia") +
theme_light()
wtd.cor(tract$medianinc, tract$si_1000, weight = tract$pop)
ggplot(data = tract,
aes(x = blackshare,
y = medianinc,
size = si_1000,
color = si_1000)) +
geom_point(alpha = 0.1) +
scale_color_gradient(low = "yellow", high = "red") +
scale_size(range = c(0.1, 5), guide = "none") +
labs(title = "...", x = "Black Share", y = "Median Income",
color = "Shutoffs per capita")
ggplot(data = tract,
aes(x = blackshare,
y = medianinc,
size = si_1000,
color = si_1000)) +
geom_point(alpha = 0.1) +
scale_color_gradient(low = "yellow", high = "red") +
scale_size(range = c(0.1, 5), guide = "none") +
labs(title = "Shutoffs per Capita by Median Income and Black Share", x = "Black Share", y = "Median Income",
color = "Shutoffs per capita")
ggplot(data = tract,
aes(x = blackshare,
y = medianinc,
size = si_1000,
color = si_1000)) +
geom_point(alpha = 0.1) +
scale_color_gradient(low = "yellow", high = "purple") +
scale_size(range = c(0.1, 5), guide = "none") +
labs(title = "Shutoffs per Capita by Median Income and Black Share", x = "Black Share", y = "Median Income",
color = "Shutoffs per capita")
wtd.cor(tract$medianinc, tract$blackshare, weight = tract$pop)
wtd.cor(tract$medianinc, tract$blackshare, weight = tract$si_1000)
wtd.cor(tract$blackshare, tract$medianinc, weight = tract$si_1000)
library(readstata13)
library(tidyverse)
library(lubridate)
library(weights)
getwd()
MI_acs_tract_10_17 <- readRDS("Data/MI_acs_tract_10_17.rds")
input_si <- read.dta13("Data/si_1017_cleaned.dta")
si.clean <- input_si %>%
select(si_order_number, census_tract_long, year, month) %>%
rename(tractid = census_tract_long) %>%
arrange(tractid, year, month)
si_tract_ym <- si.clean %>%
group_by(tractid, year, month) %>%
summarise(si_count = n_distinct(si_order_number)) %>%
arrange(tractid, year, month)
tract_ym <- left_join(si_tract_ym, MI_acs_tract_10_17,
by = c("tractid", "year")) %>%
mutate(date = make_date(year, month, 1)) %>%
arrange(tractid, year, month) %>%
filter(date != "2017-11-01")
tract <- tract_ym %>%
group_by(tractid) %>%
summarise(si_count = sum(si_count),
pop = mean(pop, na.rm = TRUE),
blackshare = mean(blackshare, na.rm = TRUE),
black75 = round(mean(black75, na.rm = TRUE), 0),
medianinc = mean(medianinc, na.rm = TRUE),
inc_above_median = round(mean(inc_above_median,
na.rm = TRUE), 0) ) %>%
mutate(si_1000 = si_count / (pop / 1000) ) %>%
arrange(tractid)
ggplot(data = tract,
aes(x = blackshare,
y = si_1000,
size = pop)) +
geom_point(alpha = 0.1, color = "red") +
scale_size(range = c(0.1, 6), guide = "none") +
labs(title = "Black Share and Shutoffs per Capita", x = "% Black",
y = "Shutoffs per Capita") +
theme_light()
wtd.cor(tract$blackshare, tract$si_1000, weight = tract$pop)
ggplot(data = tract,
aes(x = medianinc,
y = si_1000,
size = pop)) +
geom_point(alpha = 0.1, color = "blue") +
scale_size(range = c(0.1, 6), guide = "none") +
labs(title = "Median Income vs. Shutoffs per Capita", x = "Median Income",
y = "Shutoffs per Captia") +
theme_light()
wtd.cor(tract$medianinc, tract$si_1000, weight = tract$pop)
ggplot(data = tract,
aes(x = blackshare,
y = medianinc,
size = si_1000,
color = si_1000)) +
geom_point(alpha = 0.1) +
scale_color_gradient(low = "yellow", high = "purple") +
scale_size(range = c(0.1, 5), guide = "none") +
labs(title = "Shutoffs per Capita by Median Income and Black Share", x = "Black Share", y = "Median Income",
color = "Shutoffs per capita")
wtd.cor(tract$blackshare, tract$medianinc, weight = tract$si_1000)
detroit_pop_hi_inc <- tract %>%
filter(inc_above_median == 1) %>%
summarise(sum(pop)) %>%
as.numeric()
detroit_pop_lo_inc <- tract %>%
filter(inc_above_median == 0) %>%
summarise(sum(pop)) %>%
as.numeric()
ym_inc <- tract_ym %>%
group_by(date, inc_above_median) %>%
summarise(si_count = sum(si_count)) %>%
mutate(pop = if_else(inc_above_median == 1,
detroit_pop_hi_inc,
detroit_pop_lo_inc),
si_1000 = si_count / (pop / 1000)) %>%
na.omit()
ym_inc <- tract_ym %>%
group_by(date, inc_above_median) %>%
summarise(si_count = sum(si_count)) %>%
na.omit() %>%
ungroup() %>%
complete(date,
inc_above_median,
fill = list(si_count = 0)) %>%
mutate(pop = if_else(inc_above_median == 1,
detroit_pop_hi_inc,
detroit_pop_lo_inc),
si_1000 = si_count / (pop / 1000))
ym_inc$inc_above_median <- factor(ym_inc$inc_above_median,
levels = c(0,1),
labels = c("Below median income",
"Above median income"))
ggplot(ym_inc,
aes(x = date, y = si_1000, color = inc_above_median)) +
geom_line()
detroit_pop_black <- tract %>%
filter(black75 == 1) %>%
summarise(sum(pop)) %>%
as.numeric()
detroit_pop_nblack <- tract %>%
filter(black75 == 0) %>%
summarise(sum(pop)) %>%
as.numeric()
ym_race <- tract_ym %>%
group_by(date, black75) %>%
summarise(si_count = sum(si_count)) %>%
na.omit() %>%
ungroup() %>%
complete(date, black75, fill = list(si_count = 0)) %>%
mutate(pop = if_else(black75 == 1,
detroit_pop_black,
detroit_pop_nblack),
si_1000 = si_count / (pop / 1000))
ggplot(ym_race,
aes(x = date, y = si_1000, color = detroit_pop_black)) +
geom_line()
detroit_pop_black <- tract %>%
filter(black75 == 1) %>%
summarise(sum(pop)) %>%
as.numeric()
detroit_pop_nblack <- tract %>%
filter(black75 == 0) %>%
summarise(sum(pop)) %>%
as.numeric()
ym_race <- tract_ym %>%
group_by(date, black75) %>%
summarise(si_count = sum(si_count)) %>%
na.omit() %>%
ungroup() %>%
complete(date, black75, fill = list(si_count = 0)) %>%
mutate(pop = if_else(black75 == 1,
detroit_pop_black,
detroit_pop_nblack),
si_1000 = si_count / (pop / 1000))
ym_race$detroit_pop_black <- factor(ym_race$detroit_pop_black,
levels = c(0,1),
labels = c("Below 75% Black",
"Above 75% Black"))
detroit_pop_black <- tract %>%
filter(black75 == 1) %>%
summarise(sum(pop)) %>%
as.numeric()
detroit_pop_nblack <- tract %>%
filter(black75 == 0) %>%
summarise(sum(pop)) %>%
as.numeric()
ym_race <- tract_ym %>%
group_by(date, black75) %>%
summarise(si_count = sum(si_count)) %>%
na.omit() %>%
ungroup() %>%
complete(date, black75, fill = list(si_count = 0)) %>%
mutate(pop = if_else(black75 == 1,
detroit_pop_black,
detroit_pop_nblack),
si_1000 = si_count / (pop / 1000))
ym_race$detroit_pop_black <- factor(ym_race$detroit_pop_black,
levels = c(0,1),
labels = c("Below 75% Black",
"Above 75% Black"))
View(ym_race)
View(ym_inc)
detroit_pop_black <- tract %>%
filter(black75 == 1) %>%
summarise(sum(pop)) %>%
as.numeric()
detroit_pop_nblack <- tract %>%
filter(black75 == 0) %>%
summarise(sum(pop)) %>%
as.numeric()
ym_race <- tract_ym %>%
group_by(date, black75) %>%
summarise(si_count = sum(si_count)) %>%
na.omit() %>%
ungroup() %>%
complete(date, black75, fill = list(si_count = 0)) %>%
mutate(pop = if_else(black75 == 1,
detroit_pop_black,
detroit_pop_nblack),
si_1000 = si_count / (pop / 1000))
ym_race$black75 <- factor(ym_race$black75,
levels = c(0,1),
labels = c("Below 75% Black",
"Above 75% Black"))
ggplot(ym_race,
aes(x = date, y = si_1000, color = detroit_pop_black)) +
geom_line()
ggplot(ym_race,
aes(x = date, y = si_1000, color = black75)) +
geom_line()
ggplot(ym_race,
aes(x = date, y = si_1000, color = detroit_pop_black)) +
geom_line()
ggplot(ym_race,
aes(x = date, y = si_1000, color = black75)) +
geom_line()
wtd.cor(ym_race$black75, ym_race$si_1000, weight = ym_race$pop)
wtd.cor(ym_race$black75, ym_race$si_1000)
cor(ym_race$black75, ym_race$si_1000)
ggplot(ym_inc,
aes(x = date, y = si_1000, color = inc_above_median)) +
geom_line() +
labs(title = "Shutoffs per Capita Over Time Above & Below Citywide Cedian Housheold Income")
ggplot(ym_inc,
aes(x = date, y = si_1000, color = inc_above_median)) +
geom_line() +
labs(title = "Shutoffs per Capita Over Time Above & Below Citywide Cedian Housheold Income",
x = "Date", y = "Shutoffs per Capita", color = "Median Income")
ggplot(ym_race,
aes(x = date, y = si_1000, color = black75)) +
geom_line() +
labs(title = "Shutoffs per Capita Over Time for Tracts Above and Below 75% Black",
x = "Date", y = "Shutoffs per Capita", color = "Percent Black")
wtd.cor(tract$blackshare, tract$medianinc, weight = tract$pop)
wtd.cor(ym_inc$date, ym_inc$si_1000, weights = ym_inc$pop)
wtd.cor(ym_inc$date, ym_inc$si_1000)
wtd.cor(ym_inc$date, ym_inc$si_1000, weights = ym_inc$inc_above_median)
wtd.cor(ym_inc$inc_above_median, ym_inc$si_1000)
cor(ym_inc$date, ym_inc$si_1000)
cor(ym_inc$date, ym_inc$si_1000)
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(readstata13)
library(tidyverse)
library(lubridate)
library(weights)
getwd()
MI_acs_tract_10_17 <- readRDS("Data/MI_acs_tract_10_17.rds")
input_si <- read.dta13("Data/si_1017_cleaned.dta")
si.clean <- input_si %>%
select(si_order_number, census_tract_long, year, month) %>%
rename(tractid = census_tract_long) %>%
arrange(tractid, year, month)
si_tract_ym <- si.clean %>%
group_by(tractid, year, month) %>%
summarise(si_count = n_distinct(si_order_number)) %>%
arrange(tractid, year, month)
tract_ym <- left_join(si_tract_ym, MI_acs_tract_10_17,
by = c("tractid", "year")) %>%
mutate(date = make_date(year, month, 1)) %>%
arrange(tractid, year, month) %>%
filter(date != "2017-11-01")
tract <- tract_ym %>%
group_by(tractid) %>%
summarise(si_count = sum(si_count),
pop = mean(pop, na.rm = TRUE),
blackshare = mean(blackshare, na.rm = TRUE),
black75 = round(mean(black75, na.rm = TRUE), 0),
medianinc = mean(medianinc, na.rm = TRUE),
inc_above_median = round(mean(inc_above_median,
na.rm = TRUE), 0) ) %>%
mutate(si_1000 = si_count / (pop / 1000) ) %>%
arrange(tractid)
ggplot(data = tract,
aes(x = blackshare,
y = si_1000,
size = pop)) +
geom_point(alpha = 0.1, color = "red") +
scale_size(range = c(0.1, 6), guide = "none") +
labs(title = "Black Share and Shutoffs per Capita", x = "% Black",
y = "Shutoffs per Capita") +
theme_light()
wtd.cor(tract$blackshare, tract$si_1000, weight = tract$pop)
ggplot(data = tract,
aes(x = medianinc,
y = si_1000,
size = pop)) +
geom_point(alpha = 0.1, color = "blue") +
scale_size(range = c(0.1, 6), guide = "none") +
labs(title = "Median Income vs. Shutoffs per Capita", x = "Median Income",
y = "Shutoffs per Captia") +
theme_light()
wtd.cor(tract$medianinc, tract$si_1000, weight = tract$pop)
ggplot(data = tract,
aes(x = blackshare,
y = medianinc,
size = si_1000,
color = si_1000)) +
geom_point(alpha = 0.1) +
scale_color_gradient(low = "yellow", high = "purple") +
scale_size(range = c(0.1, 5), guide = "none") +
labs(title = "Shutoffs per Capita by Median Income and Black Share", x = "Black Share", y = "Median Income",
color = "Shutoffs per capita")
wtd.cor(tract$blackshare, tract$medianinc, weight = tract$pop)
detroit_pop_hi_inc <- tract %>%
filter(inc_above_median == 1) %>%
summarise(sum(pop)) %>%
as.numeric()
detroit_pop_lo_inc <- tract %>%
filter(inc_above_median == 0) %>%
summarise(sum(pop)) %>%
as.numeric()
ym_inc <- tract_ym %>%
group_by(date, inc_above_median) %>%
summarise(si_count = sum(si_count)) %>%
mutate(pop = if_else(inc_above_median == 1,
detroit_pop_hi_inc,
detroit_pop_lo_inc),
si_1000 = si_count / (pop / 1000)) %>%
na.omit()
ym_inc <- tract_ym %>%
group_by(date, inc_above_median) %>%
summarise(si_count = sum(si_count)) %>%
na.omit() %>%
ungroup() %>%
complete(date,
inc_above_median,
fill = list(si_count = 0)) %>%
mutate(pop = if_else(inc_above_median == 1,
detroit_pop_hi_inc,
detroit_pop_lo_inc),
si_1000 = si_count / (pop / 1000))
ym_inc$inc_above_median <- factor(ym_inc$inc_above_median,
levels = c(0,1),
labels = c("Below median income",
"Above median income"))
ggplot(ym_inc,
aes(x = date, y = si_1000, color = inc_above_median)) +
geom_line() +
labs(title = "Shutoffs per Capita Over Time Above & Below Citywide Median Housheold Income",
x = "Date", y = "Shutoffs per Capita", color = "Median Income")
detroit_pop_black <- tract %>%
filter(black75 == 1) %>%
summarise(sum(pop)) %>%
as.numeric()
detroit_pop_nblack <- tract %>%
filter(black75 == 0) %>%
summarise(sum(pop)) %>%
as.numeric()
ym_race <- tract_ym %>%
group_by(date, black75) %>%
summarise(si_count = sum(si_count)) %>%
na.omit() %>%
ungroup() %>%
complete(date, black75, fill = list(si_count = 0)) %>%
mutate(pop = if_else(black75 == 1,
detroit_pop_black,
detroit_pop_nblack),
si_1000 = si_count / (pop / 1000))
ym_race$black75 <- factor(ym_race$black75,
levels = c(0,1),
labels = c("Below 75% Black",
"Above 75% Black"))
ggplot(ym_race,
aes(x = date, y = si_1000, color = black75)) +
geom_line() +
labs(title = "Shutoffs per Capita Over Time for Tracts Above and Below 75% Black",
x = "Date", y = "Shutoffs per Capita", color = "Percent Black")
